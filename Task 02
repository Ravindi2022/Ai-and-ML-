% Directory containing the files
dataDir = 'C:\Users\ASUS\Documents\Computer Science @Plymuni . NSBM\3rd Year\AI and ML\Coursework\New folder';

% Filter for .mat files and exclude 'matlab.mat'
files = dir(fullfile(dataDir, '*.mat'));
files = files(~strcmp({files.name}, 'matlab.mat')); % Exclude 'matlab.mat'
if isempty(files)
    error('No valid .mat files found in the directory. Please check the file extensions or path.');
else
    disp(['Number of .mat files found: ', num2str(length(files))]);
end

% Initialize variables
data_groups = containers.Map('KeyType', 'double', 'ValueType', 'any'); % Use 'double' for numeric keys

% Load and group data by feature count
for i = 1:length(files)
    filePath = fullfile(files(i).folder, files(i).name);
    disp(['Processing file: ', files(i).name]);
    
    % Load the data
    try
        data = load(filePath);
    catch ME
        disp(['Error loading file: ', files(i).name, ' - ', ME.message]);
        continue;
    end
    
    % Get field names in the .mat file
    featureKey = fieldnames(data);
    if isempty(featureKey)
        disp(['Skipping file: ', files(i).name, ' - No fields found in the data.']);
        continue;
    end
    disp(['Fields in the file: ', files(i).name]);
    disp(featureKey);

    % Access the first field (assuming it contains features)
    try
        features = data.(featureKey{1}); % Adjust if necessary
    catch
        disp(['Skipping file: ', files(i).name, ' - Unable to access the first field.']);
        continue;
    end

    % Validate features
    if isempty(features) || ~isnumeric(features)
        disp(['Skipping file: ', files(i).name, ' - Data is empty or not numeric.']);
        continue;
    end
    
    % Display data size for debugging
    disp(['File: ', files(i).name, ', Size: ', num2str(size(features))]);

    % Group by feature count
    feature_count = size(features, 2); % Number of features (columns)
    if ~isKey(data_groups, feature_count)
        data_groups(feature_count) = features;
    else
        data_groups(feature_count) = [data_groups(feature_count); features];
    end
end

% Train and evaluate MLP for each feature group
feature_keys = keys(data_groups);
for k = 1:length(feature_keys)
    feature_count = feature_keys{k};
    dataset = data_groups(feature_count);
    
    disp(['Training MLP for ', num2str(feature_count), '-feature dataset...']);
    
    % Split data into training and testing sets
    [n_samples, n_features] = size(dataset);
    labels = randi([0, 1], n_samples, 1); % Example: Generate random binary labels
    
    % Shuffle data
    perm = randperm(n_samples);
    dataset = dataset(perm, :);
    labels = labels(perm, :);

    % 80% training, 20% testing
    train_ratio = 0.8;
    n_train = round(train_ratio * n_samples);
    train_data = dataset(1:n_train, :);
    train_labels = labels(1:n_train);
    test_data = dataset(n_train+1:end, :);
    test_labels = labels(n_train+1:end);

    % Train MLP
    net = feedforwardnet(10); % 10 hidden neurons (adjust as necessary)
    net.trainParam.showWindow = false; % Suppress GUI for automated runs
    net = train(net, train_data', train_labels'); % Transpose for MATLAB format

    % Test MLP
    predictions = net(test_data')';
    predictions = round(predictions); % Convert outputs to binary for comparison
    
    % Evaluate performance
    accuracy = mean(predictions == test_labels);
    disp(['Accuracy for ', num2str(feature_count), '-feature dataset: ', num2str(accuracy * 100), '%']);
end
