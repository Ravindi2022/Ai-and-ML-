% Directory containing the files
dataDir = 'C:\Users\ASUS\Documents\Computer Science @Plymuni . NSBM\3rd Year\AI and ML\Coursework\New folder';

% Display directory path
disp(['Checking directory: ', dataDir]);

% Check directory content
disp('Checking directory content...');
dirContent = dir(dataDir);
if isempty(dirContent)
    error('Directory is empty or path is incorrect.');
else
    disp('Files in the directory:');
    disp({dirContent.name});
end

% Filter for .mat files
files = dir(fullfile(dataDir, '*.mat'));
if isempty(files)
    error('No .mat files found in the directory. Please check the file extensions or path.');
else
    disp(['Number of .mat files found: ', num2str(length(files))]);
    disp({files.name});
end

% Initialize variables for intra-user variance
intra_user_variance = {};
user_ids = {};
feature_counts = [];

% Loop through each file
for i = 1:length(files)
    filePath = fullfile(files(i).folder, files(i).name);
    disp(['Processing file: ', files(i).name]);
    
    % Load the data
    try
        data = load(filePath);
    catch ME
        disp(['Error loading file: ', files(i).name, ' - ', ME.message]);
        continue;
    end
    
    % Get field names in the .mat file
    featureKey = fieldnames(data);
    if isempty(featureKey)
        disp(['Skipping file: ', files(i).name, ' - No fields found in the data.']);
        continue;
    end
    disp(['Fields in the file: ', files(i).name]);
    disp(featureKey);

    % Access the first field (assuming it contains features)
    try
        features = data.(featureKey{1}); % Adjust if necessary
    catch
        disp(['Skipping file: ', files(i).name, ' - Unable to access the first field.']);
        continue;
    end

    % Validate features
    if isempty(features) || ~isnumeric(features)
        disp(['Skipping file: ', files(i).name, ' - Data is empty or not numeric.']);
        continue;
    end

    % Extract user ID
    [~, fileName, ~] = fileparts(files(i).name);
    user_id = fileName(1:3); % e.g., 'U01'
    user_ids = [user_ids; user_id];
    feature_counts = [feature_counts; size(features, 2)];

    % Calculate intra-user variance
    variance_within_user = var(features, 0, 1); % Variance across rows (samples)
    intra_user_variance{end+1} = variance_within_user; % Store intra-user variance
end

% Display results for intra-user variance
unique_feature_counts = unique(feature_counts);
for u = 1:length(unique_feature_counts)
    count = unique_feature_counts(u);
    disp(['Intra-user variance for files with ', num2str(count), ' features:']);
    
    % Filter intra-user variance for this feature group
    group_idx = (feature_counts == count);
    
    % Concatenate intra-user variance for this group
    group_intra_variance = vertcat(intra_user_variance{group_idx});
    
    % Display as table
    intraVarianceTable = array2table(group_intra_variance, ...
        'VariableNames', strcat('Feature_', string(1:count)));
    disp('Intra-User Variance Table:');
    disp(intraVarianceTable);
    
    % Plot intra-user variance
    figure;
    bar(mean(group_intra_variance, 1)); % Average intra-user variance
    title(['Average Intra-User Variance for ', num2str(count), ' Features']);
    xlabel('Feature Index');
    ylabel('Variance');
    xticks(1:count);
    grid on;
end
